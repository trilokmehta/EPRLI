<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CUET Pro - NTA Test Session</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e9e9e9;
        }
        /* NTA Palette and Legend Styles */
        .not-visited { background-color: #f0f0f0; color: #333; border: 1px solid #ccc; }
        .not-answered { background-color: #e74c3c; color: white; }
        .answered { background-color: #2ecc71; color: white; }
        .marked { background-color: #9b59b6; color: white; }
        .answered-marked { background-color: #9b59b6; color: white; position: relative; }
        .answered-marked::after {
            content: '';
            position: absolute;
            bottom: 3px;
            right: 3px;
            width: 8px;
            height: 8px;
            background-color: #2ecc71;
            border-radius: 50%;
        }
        .question-palette-btn {
            width: 40px;
            height: 30px;
            border-radius: 4px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s ease;
        }
        #question-content {
            min-height: 80px;
        }

        .current-q {
            border: 2px solid #3498db;
            transform: scale(1.1);
        }
        .option-button:hover:not(:disabled) {
            background-color: #ecf0f1;
        }
        /* --- ADDED/MODIFIED STYLES FOR INSTANT FEEDBACK --- */
        .option-button.correct {
            background-color: #dcfce7; /* green-100 */
            border-color: #22c55e; /* green-500 */
            color: #166534; /* green-800 */
            font-weight: 600;
        }
        .option-button.wrong {
            background-color: #fee2e2; /* red-100 */
            border-color: #ef4444; /* red-500 */
            color: #991b1b; /* red-800 */
            font-weight: 600;
        }
        .option-button:disabled {
            cursor: not-allowed;
        }
        /* Custom scrollbar */
        #question-palette::-webkit-scrollbar { width: 5px; }
        #question-palette::-webkit-scrollbar-track { background: #f1f1f1; }
        #question-palette::-webkit-scrollbar-thumb { background: #888; border-radius: 2px; }
        #question-palette::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="text-gray-900">
    <div id="app" class="hidden">
        
        <header class="bg-white shadow-sm sticky top-0 z-40 border-b">
            <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-2">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <img src="https://placehold.co/56x56/EFEFEF/333333?text=User" alt="User Avatar" class="h-14 w-14 rounded-full">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Candidate Name: <span id="user-name" class="font-bold text-gray-800">[Your Name]</span></p>
                            <p class="text-sm font-medium text-gray-500">Subject Name: <span id="header-subject-name" class="font-bold text-gray-800">[Subject]</span></p>
                        </div>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500 flex items-center">
                            <svg class="w-5 h-5 mr-1 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Time Elapsed: <span id="timer-display" class="font-bold text-lg text-blue-600 ml-2">00:00:00</span>
                        </p>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-screen-2xl mx-auto p-2 md:p-4 lg:p-6">
            <div id="view-container">
                <div id="loading-view" class="text-center p-10"><p class="text-gray-600 font-medium">Preparing your test...</p></div>

                <section id="test-view" class="hidden">
                    <div class="lg:flex lg:gap-6">
                        <div class="flex-grow bg-white p-4 md:p-6 rounded-md shadow-sm border">
                            <div class="flex justify-between items-center mb-4 border-b border-gray-200 pb-3">
                                <h2 id="question-title" class="text-lg font-bold text-gray-700">Question <span id="current-q-number">1</span></h2>
                            </div>
                            <div id="question-content" class="text-lg mb-2 leading-relaxed min-h-[80px]">
                                <p id="question-text"></p>
                            </div>
                            
                            <div id="options-container" class="space-y-3"></div>
                            
                            <div id="explanation-container" class="mt-4 hidden">
                                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                                    <p class="font-semibold text-blue-900 mb-2">Explanation:</p>
                                    <p id="explanation-text" class="text-gray-700"></p>
                                </div>
                            </div>

                            <div class="border-t border-gray-200 mt-6 pt-4 space-y-4">
                                <div class="flex flex-wrap gap-3">
                                    <button id="save-next-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm font-medium shadow-sm">SAVE & NEXT</button>
                                    <button id="save-mark-btn" class="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 text-sm font-medium shadow-sm">SAVE & MARK FOR REVIEW</button>
                                </div>
                                <div class="flex items-center justify-between pt-2">
                                    <div class="flex items-center space-x-4">
                                        <button id="prev-btn" class="font-bold text-gray-600 hover:text-black">&lt;&lt; BACK</button>
                                        <button id="next-btn" class="font-bold text-gray-600 hover:text-black">NEXT &gt;&gt;</button>
                                    </div>
                                    <button id="submit-test-btn" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold shadow-sm">Submit Test</button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-md shadow-sm border lg:w-80 lg:flex-shrink-0 mt-6 lg:mt-0">
                             <div id="palette-legend" class="grid grid-cols-2 gap-x-4 gap-y-3 mb-4 p-3 border border-dashed rounded-md text-xs">
                                <div class="flex items-center space-x-2"><span id="answered-count" class="w-6 h-6 flex items-center justify-center font-bold answered">0</span><p>Answered</p></div>
                                <div class="flex items-center space-x-2"><span id="not-answered-count" class="w-6 h-6 flex items-center justify-center font-bold not-answered">0</span><p>Not Answered</p></div>
                                <div class="flex items-center space-x-2"><span id="not-visited-count" class="w-6 h-6 flex items-center justify-center font-bold not-visited">0</span><p>Not Visited</p></div>
                                <div class="flex items-center space-x-2"><span id="marked-count" class="w-6 h-6 flex items-center justify-center font-bold marked rounded-full">0</span><p>Marked</p></div>
                                <div class="col-span-2 flex items-center space-x-2"><span id="answered-marked-count" class="w-6 h-6 flex items-center justify-center font-bold answered-marked rounded-full">0</span><p>Answered & Marked</p></div>
                            </div>
                            <div id="question-palette" class="grid grid-cols-5 gap-2 max-h-[300px] overflow-y-auto pr-2"></div>
                        </div>
                    </div>
                </section>
                
                <section id="results-view" class="hidden text-center max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold mb-2">Test Submitted!</h2>
                    <p class="text-gray-600 mb-8">Your results have been saved.</p>
                    <div class="mb-8">
                        <span id="score-text" class="text-6xl font-extrabold text-indigo-600"></span>
                        <p class="text-gray-500 font-medium mt-1">Final Score</p>
                    </div>
                    <div class="grid grid-cols-3 gap-4 text-center p-6 bg-gray-50 rounded-lg mb-8">
                        <div><p id="results-correct" class="font-bold text-2xl text-green-600">0</p><p class="text-sm text-gray-500">Correct</p></div>
                        <div><p id="results-incorrect" class="font-bold text-2xl text-red-600">0</p><p class="text-sm text-gray-500">Incorrect</p></div>
                        <div><p id="results-unattempted" class="font-bold text-2xl text-gray-700">0</p><p class="text-sm text-gray-500">Unattempted</p></div>
                    </div>
                    <a href="home.html" class="w-full max-w-xs mx-auto inline-block px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold">Back to Dashboard</a>
                </section>
            </div>
        </div>
    </div>
    
    <script>
        const SUPABASE_URL = 'https://laredtouarpjxmzwvcco.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxhcmVkdG91YXJwanhtend2Y2NvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNzkxMjMsImV4cCI6MjA3NDk1NTEyM30.pJR9Nky9eECeyMmNU1tux3VuywX7Cl_zmP7eCf7iZ3I';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = null;
        let timerInterval;

        // DOM Elements
        const views = { loading: document.getElementById('loading-view'), test: document.getElementById('test-view'), results: document.getElementById('results-view') };
        const questionText = document.getElementById('question-text'), optionsContainer = document.getElementById('options-container'), currentQNumber = document.getElementById('current-q-number'), questionPalette = document.getElementById('question-palette');
        const scoreText = document.getElementById('score-text'), resultsCorrect = document.getElementById('results-correct'), resultsIncorrect = document.getElementById('results-incorrect'), resultsUnattempted = document.getElementById('results-unattempted');
        
        // Buttons
        const saveNextBtn = document.getElementById('save-next-btn');
        const saveMarkBtn = document.getElementById('save-mark-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const submitTestBtn = document.getElementById('submit-test-btn');
        
        // State
        let currentQuestions = [], testState = [], currentSubjectId = null, currentQuestionIndex = 0;

        function switchView(viewName) {
            Object.values(views).forEach(v => v.classList.add('hidden'));
            if(views[viewName]) views[viewName].classList.remove('hidden');
        }
        
        supabaseClient.auth.getSession().then(({ data: { session } }) => {
            if (!session) {
                window.location.href = 'login.html';
            } else {
                currentUser = session.user;
                document.getElementById('app').classList.remove('hidden');
                initializeTest();
            }
        });

        async function saveResultsToSupabase() {
            const recordsToUpsert = testState.map((state, index) => {
                if (state.status === 'not-visited' && state.selectedOption === null) return null;
                
                const question = currentQuestions[index];
                const isCorrect = state.selectedOption === question.answer;
                
                let finalStatus = 'incorrect';
                if (state.selectedOption === null) {
                    finalStatus = 'unattempted';
                } else if (isCorrect) {
                    finalStatus = 'correct';
                }

                return {
                    user_id: currentUser.id,
                    question_id: question.id,
                    subject_id: currentSubjectId,
                    status: finalStatus,
                    topic: question.topic,
                    difficulty: question.difficulty
                };
            }).filter(Boolean);

            if (recordsToUpsert.length > 0) {
                const { error } = await supabaseClient
                    .from('user_question_status')
                    .upsert(recordsToUpsert, { onConflict: 'user_id, question_id' });
                if (error) console.error("Error saving results:", error);
            }
        }

        async function submitTest() {
            clearInterval(timerInterval);
            await saveResultsToSupabase();

            let correct = 0, incorrect = 0, unattempted = 0;
            testState.forEach((state, index) => {
                if (state.selectedOption === null) {
                    unattempted++;
                } else if (state.selectedOption === currentQuestions[index].answer) {
                    correct++;
                } else {
                    incorrect++;
                }
            });

            scoreText.textContent = `${correct} / ${currentQuestions.length}`;
            resultsCorrect.textContent = correct;
            resultsIncorrect.textContent = incorrect;
            resultsUnattempted.textContent = unattempted;
            switchView('results');
        }
                
        function jumpToQuestion(index) {
            currentQuestionIndex = index;
            if (testState[index].status === 'not-visited') {
                testState[index].status = 'not-answered';
            }
            renderQuestion();
        }

        // --- MODIFIED FUNCTION ---
        function renderQuestion() {
            const question = currentQuestions[currentQuestionIndex];
            const state = testState[currentQuestionIndex];
            questionText.textContent = question.question;

            optionsContainer.innerHTML = question.options.map((option, index) => {
                return `<button class="option-button w-full text-left p-3 border rounded-md transition-all" data-option-index="${index}"><span>${String.fromCharCode(65 + index)}. ${option}</span></button>`;
            }).join('');

            const explanationContainer = document.getElementById('explanation-container');
            const explanationText = document.getElementById('explanation-text');

            if (question.explanation) {
                explanationText.textContent = question.explanation;
                explanationContainer.classList.add('hidden');
            } else {
                explanationContainer.classList.add('hidden');
            }

            if (state.selectedOption !== null) {
                const allOptionButtons = optionsContainer.querySelectorAll('.option-button');
                const selectedIndex = state.selectedOption;
                const correctAnswerIndex = question.answer;

                allOptionButtons.forEach((btn, index) => {
                    btn.disabled = true;
                    if (index === correctAnswerIndex) {
                        btn.classList.add('correct');
                    } else if (index === selectedIndex) {
                        btn.classList.add('wrong');
                    }
                });

                if (question.explanation) {
                    explanationContainer.classList.remove('hidden');
                }
            }

            currentQNumber.textContent = currentQuestionIndex + 1;
            updatePalette();
        }


        function updatePalette() {
            let answered = 0, notAnswered = 0, notVisited = 0, marked = 0, answeredMarked = 0;
            testState.forEach(state => {
                switch(state.status) {
                    case 'answered': answered++; break;
                    case 'not-answered': notAnswered++; break;
                    case 'not-visited': notVisited++; break;
                    case 'marked': marked++; break;
                    case 'answered-marked': answeredMarked++; break;
                }
            });

            document.getElementById('answered-count').textContent = answered;
            document.getElementById('not-answered-count').textContent = notAnswered;
            document.getElementById('not-visited-count').textContent = notVisited;
            document.getElementById('marked-count').textContent = marked;
            document.getElementById('answered-marked-count').textContent = answeredMarked;

            questionPalette.innerHTML = testState.map((state, index) => {
                const statusClass = state.status;
                return `<button class="question-palette-btn ${statusClass} ${index === currentQuestionIndex ? 'current-q' : ''}" data-q-index="${index}">${index + 1}</button>`;
            }).join('');
        }
        
        function startTimer(durationMinutes) {
            let totalSeconds = 0;
            const timerDisplay = document.getElementById('timer-display');
            
            timerInterval = setInterval(() => {
                totalSeconds++;
                const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
                const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
                const seconds = (totalSeconds % 60).toString().padStart(2, '0');
                timerDisplay.textContent = `${hours}:${minutes}:${seconds}`;
            }, 1000);
        }

        async function initializeTest() {
            switchView('loading');
            const params = new URLSearchParams(window.location.search);
            currentSubjectId = parseInt(params.get('subject_id'));
            const subjectName = params.get('subject_name') || 'Mock Test';
            const count = parseInt(params.get('count') || 10);

            document.getElementById('header-subject-name').textContent = subjectName;
            document.getElementById('user-name').textContent = currentUser.email.split('@')[0];

            const tableName = `questions_${subjectName.toLowerCase().replace(/ /g, '_')}`;

            try {
                const { data: allQuestions, error } = await supabaseClient.from(tableName).select('*').limit(count);
                if (error) throw error;
                if (allQuestions.length === 0) throw new Error("No questions found.");
                
                currentQuestions = allQuestions;
                
                const testDurationMinutes = Math.ceil(currentQuestions.length * 1.5);
                startTimer(testDurationMinutes);
                
                testState = currentQuestions.map(() => ({ status: 'not-visited', selectedOption: null }));
                jumpToQuestion(0);
                switchView('test');
            } catch (error) {
                console.error("Error preparing test:", error);
                alert(`Could not load questions for ${subjectName}. Redirecting to dashboard.`);
                window.location.href = 'index.html';
            }
        }
        
        // --- MODIFIED EVENT LISTENER ---
        optionsContainer.addEventListener('click', (e) => {
            const clickedButton = e.target.closest('button[data-option-index]');
            if (!clickedButton || clickedButton.disabled) return;

            const selectedIndex = parseInt(clickedButton.dataset.optionIndex);
            const question = currentQuestions[currentQuestionIndex];
            const state = testState[currentQuestionIndex];
            const correctAnswerIndex = question.answer;

            state.selectedOption = selectedIndex;

            const allOptionButtons = optionsContainer.querySelectorAll('.option-button');

            allOptionButtons.forEach((btn, index) => {
                btn.disabled = true;
                if (index === correctAnswerIndex) {
                    btn.classList.add('correct');
                } else if (index === selectedIndex) {
                    btn.classList.add('wrong');
                }
            });
            
            const explanationContainer = document.getElementById('explanation-container');
            if (question.explanation) {
                explanationContainer.classList.remove('hidden');
            }
        });

        
        questionPalette.addEventListener('click', (e) => {
            const button = e.target.closest('button[data-q-index]');
            if (button) {
                const index = parseInt(button.dataset.qIndex);
                jumpToQuestion(index);
            }
        });
        
        function handleNavigation(isNext) {
             const newIndex = isNext ? currentQuestionIndex + 1 : currentQuestionIndex - 1;
             if (newIndex >= 0 && newIndex < currentQuestions.length) {
                 jumpToQuestion(newIndex);
             } else if (isNext) {
                 alert("This is the last question.");
             }
        }

        saveNextBtn.addEventListener('click', () => {
            const state = testState[currentQuestionIndex];
            if (state.selectedOption !== null) {
                state.status = 'answered';
            } else {
                 state.status = 'not-answered';
            }
            handleNavigation(true);
        });

        saveMarkBtn.addEventListener('click', () => {
            const state = testState[currentQuestionIndex];
            if (state.selectedOption !== null) {
                state.status = 'answered-marked';
            } else {
                state.status = 'marked';
            }
            handleNavigation(true);
        });

        prevBtn.addEventListener('click', () => handleNavigation(false));
        nextBtn.addEventListener('click', () => handleNavigation(true));
        submitTestBtn.addEventListener('click', () => {
            if(confirm("Are you sure you want to submit the test?")) {
                submitTest();
            }
        });
    </script>
</body>
</html>
