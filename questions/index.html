
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CUET Pro - Test Session</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --color-primary: #007AFF; --color-light-bg: #F0F4F7; }
        body { font-family: 'Inter', sans-serif; background-color: var(--color-light-bg); }
        .fade-in { animation: fadeIn 1s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .question-palette-btn { width: 35px; height: 35px; }
        @media (min-width: 640px) { .question-palette-btn { width: 40px; height: 40px; } }
        .not-visited { background-color: #E5E7EB; color: #4B5563; }
        .answered { background-color: #10B981; color: white; }
        .not-answered { background-color: #EF4444; color: white; }
        .marked { background-color: #8B5CF6; color: white; }
        .answered-marked { background: linear-gradient(45deg, #10B981 50%, #8B5CF6 50%); color: white; }
        .current-q { border: 2px solid var(--color-primary); }
        .option-button-base { color: #4B5563; background-color: white; border-color: #D1D5DB; }
        .option-button-base:not([disabled]):hover { background-color: #F9FAFB; }
    </style>
</head>
<body class="text-gray-900">
    <div id="app" class="hidden">
        <header class="bg-white shadow-md sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <a href="index.html" class="font-extrabold text-2xl" style="color: var(--color-primary);">CUET Pro</a>
                    <div id="user-email" class="text-sm text-gray-600"></div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto p-4 md:p-6 lg:p-8">
            <div id="view-container">
                <div id="loading-view" class="text-center p-10 fade-in"><svg class="animate-spin h-10 w-8 text-gray-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="mt-4 text-gray-600 font-medium">Preparing your test...</p></div>
                <section id="test-view" class="hidden"><div class="grid lg:grid-cols-3 gap-6"><div class="lg:col-span-2 bg-white p-4 md:p-8 rounded-xl shadow-lg"><div class="flex justify-between items-center mb-4 border-b border-gray-200 pb-4"><h2 id="test-title" class="text-xl font-bold"></h2></div><p class="text-gray-500 text-sm mb-4">Question <span id="current-q-number" class="font-bold">1</span> of <span id="total-q-number" class="font-bold">10</span></p><p id="question-text" class="text-lg mb-6 leading-relaxed"></p><div id="options-container" class="space-y-3"></div>
                    
        <div id="explanation-box" class="hidden mt-6 p-4 bg-gray-100 rounded-lg border border-gray-200">
            <h4 class="font-bold text-gray-800 mb-2">Explanation</h4>
            <p id="explanation-text" class="text-gray-700"></p>
        </div>
                    <div class="flex items-center justify-between border-t border-gray-200 mt-6 pt-4"><div class="flex space-x-3"><button id="clear-response-btn" class="px-5 py-2.5 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors text-sm font-medium">Clear Response</button><button id="next-question-btn" class="px-6 py-2.5 text-white rounded-lg hover:opacity-90 transition-colors text-sm font-medium" style="background-color: var(--color-primary);">Save & Next</button></div></div></div><div class="bg-white p-4 md:p-6 rounded-xl shadow-lg self-start"><div id="question-palette" class="grid grid-cols-5 gap-3 mb-4 pt-4"></div><button id="submit-test-btn" class="w-full py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold">Submit Test</button></div></div></section>
                <section id="results-view" class="hidden fade-in text-center"><div class="bg-white max-w-2xl mx-auto p-4 md:p-8 rounded-xl shadow-lg"><h2 class="text-xl md:text-3xl font-bold mb-2">Test Complete!</h2><p class="text-gray-600 mb-8">Well done. Your results have been saved.</p><div class="mb-8"><span id="score-text" class="text-xl md:text-6xl font-extrabold" style="color: var(--color-primary);"></span><p class="text-gray-500 font-medium mt-1">Score</p></div><div class="grid grid-cols-3 gap-4 text-center p-3 md:p-6 bg-gray-50 rounded-lg mb-8"><div><p id="results-correct" class="font-bold text-2xl text-green-600">0</p><p class="text-sm text-gray-500">Correct</p></div><div><p id="results-incorrect" class="font-bold text-2xl text-red-600">0</p><p class="text-sm text-gray-500">Incorrect</p></div><div><p id="results-unattempted" class="font-bold text-2xl text-gray-700">0</p><p class="text-sm text-gray-500">Unattempted</p></div></div><a href="index.html" class="w-full max-w-xs mx-auto inline-block px-6 py-3 text-white rounded-lg hover:opacity-90 transition-colors font-semibold" style="background-color: var(--color-primary);">Back to Dashboard</a></div>
                
                </section>
            </div>
            
        </div>



    </div>
    
    <script>
        const SUPABASE_URL = 'https://laredtouarpjxmzwvcco.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxhcmVkdG91YXJwanhtend2Y2NvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNzkxMjMsImV4cCI6MjA3NDk1NTEyM30.pJR9Nky9eECeyMmNU1tux3VuywX7Cl_zmP7eCf7iZ3I';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = null;
        supabaseClient.auth.getSession().then(({ data: { session } }) => {
            if (!session) {
                window.location.href = 'login.html';
            } else {
                currentUser = session.user;
                document.getElementById('user-email').textContent = currentUser.email;
                document.getElementById('app').classList.remove('hidden');
                initializeTest();
            }
        });

        // DOM Elements
        const views = { loading: document.getElementById('loading-view'), test: document.getElementById('test-view'), results: document.getElementById('results-view') };
        const testTitle = document.getElementById('test-title'), questionText = document.getElementById('question-text'), optionsContainer = document.getElementById('options-container'), currentQNumber = document.getElementById('current-q-number'), totalQNumber = document.getElementById('total-q-number'), questionPalette = document.getElementById('question-palette'), scoreText = document.getElementById('score-text'), resultsCorrect = document.getElementById('results-correct'), resultsIncorrect = document.getElementById('results-incorrect'), resultsUnattempted = document.getElementById('results-unattempted');
        const nextQuestionBtn = document.getElementById('next-question-btn'), clearResponseBtn = document.getElementById('clear-response-btn'), submitTestBtn = document.getElementById('submit-test-btn');
        
        // State
        let currentQuestions = [], testState = [], currentSubjectId = null, currentQuestionIndex = 0;

        function switchView(viewName) { Object.values(views).forEach(v => v.classList.add('hidden')); if(views[viewName]) views[viewName].classList.remove('hidden'); }

        

async function saveResultsToSupabase() {
    // This function will now only create records for questions that were actually answered.
    const recordsToUpsert = testState.map((state, index) => {
        // If the question was skipped (no option selected), return null and ignore it.
        if (state.selectedOption === null) {
            return null;
        }
        
        const question = currentQuestions[index];
        const newStatus = state.selectedOption === question.answer ? 'correct' : 'incorrect';

        return {
            user_id: currentUser.id,
            question_id: question.id,
            subject_id: currentSubjectId,
            status: newStatus,
            topic: question.topic,
            difficulty: question.difficulty
        };
    }).filter(Boolean); // This line removes all the null (skipped) questions.

    // If there are any answered questions, save them to Supabase.
    if (recordsToUpsert.length > 0) {
        const { error } = await supabaseClient
            .from('user_question_status')
            .upsert(recordsToUpsert, { onConflict: 'user_id, question_id, subject_id' });
        
        if (error) {
            console.error("CRITICAL ERROR saving results:", error);
            alert("There was an error saving your progress. Please check the console.");
        }
    }
}

        // REPLACE your old submitTest function with this new, simpler version.

        async function submitTest() {
            // 1. Save the cumulative knowledge profile (correct/incorrect for each question)
            await saveResultsToSupabase();

            // 2. Calculate the score for this specific session
            let correct = 0, incorrect = 0, unattempted = 0;
            testState.forEach((state, index) => {
                if (state.selectedOption === null) unattempted++;
                else if (state.selectedOption === currentQuestions[index].answer) correct++;
                else incorrect++;
            });

            // 3. Display the results on the screen
            scoreText.textContent = `${correct} / ${currentQuestions.length}`;
            resultsCorrect.textContent = correct;
            resultsIncorrect.textContent = incorrect;
            resultsUnattempted.textContent = unattempted;
            switchView('results');
        }
                
        function handleNext() {
            // If this is the last question, end the test. Otherwise, go to the next one.
            if (currentQuestionIndex >= currentQuestions.length - 1) {
                submitTest();
            } else {
                jumpToQuestion(currentQuestionIndex + 1);
            }
        }

        // In the jumpToQuestion function
        function jumpToQuestion(index) {
            currentQuestionIndex = index;
            document.getElementById('explanation-box').classList.add('hidden'); // <-- ADD THIS LINE
            if (testState[index].status === 'not-visited') {
                testState[index].status = 'not-answered';
            }
            renderQuestion();
        }

        function handleClearResponse() {
            testState[currentQuestionIndex].selectedOption = null;
            renderQuestion();
        }

        // NEW renderQuestion function
// REPLACE your current renderQuestion function with this one

function renderQuestion() {
    const question = currentQuestions[currentQuestionIndex];
    const state = testState[currentQuestionIndex];
    questionText.textContent = question.question;

    // Define SVG icons for feedback
    const correctIcon = `<svg xmlns="http://www.w.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`;
    const incorrectIcon = `<svg xmlns="http://www.w.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`;

    optionsContainer.innerHTML = question.options.map((option, index) => {
        // We've added flexbox classes here to align the text and icon
        let classes = 'w-full text-left p-4 border rounded-lg option-button-base transition-all duration-200 ease-in-out active:scale-[0.98] flex items-center justify-between';
        
        let icon = ''; // Start with no icon

        if (state.selectedOption !== null) {
            if (index === question.answer) {
                classes += ' bg-green-100 border-green-500 font-semibold ring-2 ring-green-500';
                icon = correctIcon; // Add correct icon
            } else if (index === state.selectedOption) {
                classes += ' bg-red-100 border-red-500 font-semibold ring-2 ring-red-500';
                icon = incorrectIcon; // Add incorrect icon
            }
        }
        
        // The button now contains the option text and the icon
        return `<button class="${classes}" data-option-index="${index}" ${state.selectedOption !== null ? 'disabled' : ''}>
                    <span>${option}</span>
                    ${icon}
                </button>`;
    }).join('');

    currentQNumber.textContent = currentQuestionIndex + 1;
    totalQNumber.textContent = currentQuestions.length;
    updatePalette();
}

// REPLACE your old optionsContainer.addEventListener with this one

        optionsContainer.addEventListener('click', (e) => {
            if (e.target.matches('button[data-option-index]') && testState[currentQuestionIndex].selectedOption === null) {
                const index = parseInt(e.target.dataset.optionIndex);
                testState[currentQuestionIndex].selectedOption = index;
                
                if (testState[currentQuestionIndex].status !== 'marked') { 
                    testState[currentQuestionIndex].status = 'answered'; 
                } else { 
                    testState[currentQuestionIndex].status = 'answered-marked'; 
                }

                // --- NEW: Show the explanation ---
                const explanationBox = document.getElementById('explanation-box');
                const explanationText = document.getElementById('explanation-text');
                const explanation = currentQuestions[currentQuestionIndex].explanation;

                if (explanation) {
                    explanationText.textContent = explanation;
                    explanationBox.classList.remove('hidden');
                }
                // --- End of new code ---
                
                renderQuestion();
            }
        });

        function updatePalette() {
            questionPalette.innerHTML = testState.map((state, index) => {
                let statusClass = state.status;
                if (state.selectedOption !== null && state.status === 'not-answered') {
                    statusClass = 'answered'; // Visual update for answered questions
                }
                return `<button class="question-palette-btn rounded-lg font-bold flex items-center justify-center ${statusClass} ${index === currentQuestionIndex ? 'current-q' : ''}" data-q-index="${index}">${index + 1}</button>`;
            }).join('');
        }

        optionsContainer.addEventListener('click', (e) => {
            if (e.target.matches('button[data-option-index]')) {
                const index = parseInt(e.target.dataset.optionIndex);
                testState[currentQuestionIndex].selectedOption = index;
                renderQuestion();
            }
        });

        questionPalette.addEventListener('click', (e) => {
            if (e.target.matches('button[data-q-index]')) {
                const index = parseInt(e.target.dataset.qIndex);
                jumpToQuestion(index);
            }
        });

        nextQuestionBtn.addEventListener('click', handleNext);
        clearResponseBtn.addEventListener('click', handleClearResponse);
        submitTestBtn.addEventListener('click', submitTest);

        async function initializeTest() {
            const params = new URLSearchParams(window.location.search);
            currentSubjectId = parseInt(params.get('subject_id'));
            const subjectName = params.get('subject_name');
            const filter = params.get('filter') || 'all';
            const count = params.get('count');

            if (!currentSubjectId || !subjectName) {
                return window.location.href = '/home.html';
            }

            const tableName = `questions_${subjectName.toLowerCase().replace(/ /g, '_')}`;
            testTitle.textContent = `${subjectName} Practice`;

            try {
                const { data: allQuestions, error: qError } = await supabaseClient.from(tableName).select('*');
                if (qError) throw qError;
                
                const { data: userStatus, error: sError } = await supabaseClient.from('user_question_status').select('question_id, status').eq('user_id', currentUser.id).eq('subject_id', currentSubjectId);
                if (sError) throw sError;

                let filteredQuestions = [];
                const statusMap = new Map(userStatus.map(s => [s.question_id, s.status]));

                if (filter === 'all') {
                    filteredQuestions = allQuestions;
                } else if (filter === 'unattempted') {
                    filteredQuestions = allQuestions.filter(q => !statusMap.has(q.id));
                } else { // 'incorrect' or 'correct'
                    filteredQuestions = allQuestions.filter(q => statusMap.get(q.id) === filter);
                }
                
                if (filteredQuestions.length === 0) {
                    alert(`No questions found for the filter '${filter}'. Returning to dashboard.`);
                    return window.location.href = 'index.html';
                }
                
                currentQuestions = filteredQuestions.sort(() => 0.5 - Math.random());
                if (count !== 'all' && currentQuestions.length > parseInt(count)) {
                    currentQuestions = currentQuestions.slice(0, parseInt(count));
                }

                testState = currentQuestions.map(() => ({ status: 'not-visited', selectedOption: null }));
                jumpToQuestion(0);
                switchView('test');

            } catch (error) {
                console.error("Error preparing test:", error);
                alert(`Could not load questions for ${subjectName}. Check your Supabase table names, RLS policies, and ensure every question has an 'id' and 'subject_id' column.`);
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>
